<div id="base-container">
  <div class="panel-group">
    {{{collapsablePanels}}}
  </div>
</div>

<div class="modal" id="popup" role="dialog">
  <div class="modal-dialog modal-lg" >
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <button class="btn btn-primary btn-sm modal-title" onclick="Popup.Back();">Back</button>
        <!--<h4 class="modal-title center">Dictionary</h4>-->
      </div>
      <div class="modal-body">
        <div id="popup-content"></div>
      </div>
    </div>
  </div>
</div>

<script>
    try {
        var deckType = "{{deckType}}";
        var panelCount = {{panelCount}};
        {{=<% %>=}}
        var hanzi = "{{hanzi}}";
        var pinyin = "{{pinyin}}";
        var english = "{{english}}";
        <%={{ }}=%>
        function playAudio(audioFile) {
            try {
                new Audio(audioFile).play();
            } catch(html5Err) {
                try {
                    py.link('ankiplay'+audioFile);
                } catch(ankiplayErr) {
                    alert("Your version of Anki doesn't seem to support audio playback from buttons. :(");
                }
            }
        }
        function hslToRgb(h, s, l) { // To generate rainbow colors
            h /= 360;
            s /= 100;
            l /= 100;
            var r, g, b;
            if (s === 0) {
                r = g = b = l; // achromatic
            } else {
                var hue2rgb = function (p, q, t)  {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1 / 6) return p + (q - p) * 6 * t;
                    if (t < 1 / 2) return q;
                    if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                    return p;
                }
                var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                var p = 2 * l - q;
                r = hue2rgb(p, q, h + 1 / 3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1 / 3);
            }
            var toHex = function(x) {
                var hex = Math.round(x * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }
            return '#'+toHex(r)+toHex(g)+toHex(b);
        }

        function panelToggle(sectionCount) {
            $('#collapse-' + sectionCount + '}').toggle()
        }

        function generatePanel(heading, content, center, showByDefault) {
            panelCount++;
            var panelHtml = '';
            panelHtml += '<div class="panel panel-primary">';
              panelHtml += '<div class="panel-heading" onclick="panelToggle(' + panelCount + ')">';
                panelHtml += '<h4 class="panel-title">';
                  panelHtml += heading;
                panelHtml += '</h4>';
              panelHtml += '</div>';
              panelHtml += '<div id="collapse-' + panelCount + '" class="panel-collapse collapse ' + (showByDefault ? 'in' : '') + '">';
                panelHtml += '<div class="panel-body ' + (center ? 'text-center' : '') + '">';
                  panelHtml += content;
                panelHtml += '</div>';
              panelHtml += '</div>';
            panelHtml += '</div>';
            panelHtml += '<div>';
            return panelHtml;
        }

        var colorSaturation = 100 // 0-255
        var colorLightness = 40 // 0-255

        function getHanziColorAtPos(hanzi, pos) {
            var length = hanzi.replace(/[，？！。；,\?\!\.\;\s]/g,'').split('').length;
            if (pos>length)
                return "#000000";
            return hslToRgb(360/length*(pos+1), colorSaturation, colorLightness);
        }
        function hanziToHtml(hanzi) {
            var hanziHtml = '';
            var iChar = 0;
            if (hanzi.indexOf(' ')!==-1) {
                var words = hanzi.split(' ');
                words.forEach(function(word) {
                    var wordHtml = "";
                    var chars = word.split('');
                    chars.forEach(function(char) {
                        var color
                        if (!/[，？！。；,\?\!\.\;\s]/.test(char)) {
                            color = getHanziColorAtPos(hanzi, iChar);
                            iChar++;
                        }
                        wordHtml += '<span style="color:' + color + ';">' + char + '</span>';
                    });
                    hanziHtml += '<span class="hanzi-word">' + wordHtml + '</span> ';
                })
                hanziHtml = hanziHtml.slice(0,-1);
            } else if (hanzi.length>1) { // word
                var chars = hanzi.split('');
                chars.forEach(function(char) {
                    var color = getHanziColorAtPos(hanzi, iChar);
                    hanziHtml += '<span class="hanzi-char" style="color:' + color + ';">' + char + '</span>';
                    iChar++;
                })
            } else { //char
                var char = hanzi;
                var color = "#000000";
                hanziHtml = '<span class="hanzi-char" style="color:' + color + ';">' + char + '</span>';
            }
            return hanziHtml;
        }

        function colorizeByWord(words) {
            var wordArr = words.split(' ');
            var length = words.replace(/[，？！。；,\?\!\.\;]/g,'').split(' ').length;
            if (length === 1)
                return '<span style="color:#000000;">' + words + '</span> ';
            var colorizedWords = "";
            var i = 0;
            wordArr.forEach(function(word) {
                var wordSplit = word.match(/[，？！。；,\?\!\.\;]|[^，？！。；,\?\!\.\;]+/g);
                wordSplit.forEach(function(sp) {
                    if (/[，？！。；,\?\!\.\;]/.test(sp)) {
                        colorizedWords += sp;
                    } else {
                        var color = hslToRgb(360/length*(i+1), colorSaturation, colorLightness);
                        colorizedWords += '<span style="color:' + color + ';">' + sp + '</span> ';
                        i++;
                    }
                });
            });
            return colorizedWords.slice(0,-1);
        }
        function pinyinsToHtml(pinyins) {
            var pinyinHtml = '';
            pinyins.forEach(function(pinyin,i) {
                pinyinHtml += colorizeByWord(pinyin) + "<br/>"
            });
            return pinyinHtml.slice(0,-5);
        }

        var Popup = {
            History: [],
            Open: function(hanzi,noPush) {
                if (hanzi === Popup.History.slice(-1)[0])
                    return;
                if (!noPush)
                    Popup.History.push(hanzi);

                var popupContent = '';
                if (dict[hanzi]) {
                    if (dict[hanzi].traditional != hanzi) {
                        popupContent += generatePanel('Hànzì (Simplified)', '<span class="hanzi">' + hanziToHtml(hanzi) + '</span>', true, true);
                        popupContent += generatePanel('Hànzì (Traditional)', '<span class="">' + hanziToHtml(dict[hanzi].traditional) + '</span>', true, true);
                    } else {
                        popupContent += generatePanel('Hànzì', '<span class="hanzi">' + hanziToHtml(hanzi) + '</span>', true, true);
                    }

                    if (dict[hanzi].pinyin && dict[hanzi].pinyin.length > 0) {
                        popupContent += generatePanel('Pīnyīn', '<span class="pinyin">' + pinyinsToHtml(dict[hanzi].pinyin) + '</span>', true, true);
                    }

                    if (dict[hanzi].audio && dict[hanzi].audio.length > 0) {
                        popupContent += generatePanel('Chinese Audio', '<div class="chinese-audio">' + getAudioButtons(hanzi) + '</div>', true, true);
                    }

                    if (dict[hanzi].english) {
                        popupContent += generatePanel('English', '<span class="english">' + dict[hanzi].english + '</span>', true, true);
                    }

                    if (dict[hanzi].decomposition && dict[hanzi].decomposition !== '？') {
                        var decompositionHtml = "";
                        dict[hanzi].decomposition.split('').forEach(function(cmp,i) {
                            if (typeof dict[cmp] !== 'undefined') {
                                decompositionHtml += '<span class="hanzi">' + hanziToHtml(cmp) + '</span>';
                            } else {
                                decompositionHtml += cmp;
                            }
                        })
                        popupContent += generatePanel('Decomposition', '<span class="decomposition">' + decompositionHtml + '</span>', true, true);
                    }

                    if (dict[hanzi].etymology) {
                        popupContent += generatePanel('Etymology', '<div style="text-align:left" class="etymology">' + JSON.stringify(dict[hanzi].etymology, null, '    ') + '</div>', true, true);
                    }

                    if (hanzi.length === 1) {
                        popupContent += generatePanel('Stroke Order', '<div class="stroke-order center"><' + 'img alt="No stroke order diagram available for this character." src="_' + hanzi.charCodeAt() + '-still.svg"/></div>', true, true);
                    }
                } else {
                    popupContent = 'No data was found for "' + hanzi + '"!';
                }
                popupContent = '<div class="panel-group">' + popupContent + '</div>'
                $("#popup-content").html(popupContent);
                $('#popup').modal('show');
                $('#popup').scrollTop(0);
            },
            Back: function() {
                if (Popup.History.length <= 1)
                    Popup.Clear();
                if (Popup.History.length > 0) {
                    Popup.History.pop();
                    Popup.Open(Popup.History.pop());
                }
            },
            Clear: function() {
                $('#popup').modal('hide');
                Popup.History=[];
            }
        };

        function getAudioButtons(hanzi) {
            var audioButtons = "";
            if (dict[hanzi] && dict[hanzi].audio && dict[hanzi].audio.length > 0) {
                dict[hanzi].audio.forEach(function(audioFile, i) {
                    var strippedName = audioFile.replace(/^_[^ ]* - /g, '').replace(/.mp3$/, '');
                    var onclickContent = "playAudio('" + audioFile + "')";
                    var audioButton = '<button class="btn btn-info btn-block btn-sm" onclick="' + onclickContent + '">' +  '▶ ' + strippedName + '</button>';
                    audioButtons += audioButton;
                });
                var msg = "";
                if (typeof Audio === 'undefined')
                     msg = '<div style="position:relative;font-size: 8px">If audio is not working for you, install the "Replay buttons on card" addon (Code: 498789867).</div>';
                audioButtons = '<div class="btn-toolbar">' + audioButtons + '</div>' + msg;
            } else {
                audioButtons = '<div style="position:relative;font-size: 8px">No audio found for "' + hanzi + '".</div>';
            }
            return audioButtons;
        }

        var dict = {};
        function onLoadDict(dictionary) {
            dict = dictionary;
        }
        function onLoadBigDict(dictionary) {
            onLoadDict = function(){};
            dict = dictionary;
        }
        function onLibsLoaded() {
            //alert("Lib loading succeeded!");
            /*$(".p#base-container anel-body").each(function(){
                if($.trim($(this).html())=='')
                    $(this).parent().parent().hide()
            });*/
            $('#base-hanzi').html(hanziToHtml(hanzi))
            $('#base-pinyin').html(pinyinsToHtml([pinyin]))

            $('body').on('click', '.hanzi', function(event) {
                Popup.Open(event.target.innerHTML);
            });
            $('#popup').on('hidden.bs.modal', function () {
                Popup.Clear();
            });

            var audioButtons = getAudioButtons(hanzi);

            var audioSectionEl = document.querySelector('#base-container').querySelector('.chinese-audio');
            audioSectionEl.innerHTML = audioButtons;
        }
        function onLibsFailed() {
            alert("Lib loading failed!");
        }

        function isBootstrapLoaded() {
            return typeof $ == 'function' && typeof $().modal == 'function'
        }

        function loadLibs(files, success_cb, fail_cb, timeout, check, retries) {
            var timer = setTimeout(fail_cb || function(){alert("loadLibs failed!");}, timeout || 5000);
            var loadCount = 0;
            function onLibLoaded() {
                loadCount++;
                if (loadCount === files.length) {
                    clearTimeout(timer);
                    if (!check) {
                        success_cb();
                    } else if (check()) {
                        success_cb();
                    } else if (retries > 0) {
                        retries--;
                        loadLibs(files, success_cb, fail_cb, timeout, check, retries);
                    }
                }
            }
            files.forEach(function(file){
                if (file[0] !== '_')
                    alert("Error: Please rename '" + file + "' to '_" + file + "'!");
                var ext = file.split('.').slice(-1).pop();
                if (ext === 'js' || ext === 'jsonp') {
                    var script = document.createElement('script');
                    script.src = file;
                    script.addEventListener ("load", onLibLoaded);
                    //script.onload = onLibLoaded;
                    document.getElementsByTagName('head')[0].appendChild(script);
                } else if (ext === 'css') {
                    var css = document.createElement('link');
                    css.rel = 'stylesheet'
                    css.type = 'text/css';
                    css.href = file;
                    css.addEventListener ("load", onLibLoaded);
                    //css.onload = onLibLoaded;
                    document.getElementsByTagName('head')[0].appendChild(css);
                }
            })
        }
        loadLibs(['_jquery-3.js','_bootstrap-3.js','_dict-{{baseDeckId}}.jsonp'], onLibsLoaded, onLibsFailed, 1000, isBootstrapLoaded, 5);
        loadLibs(['_bootstrap-3.css','_bootstrap-3-theme.css'], function(){}, function(){}, 1000);
        loadLibs(['_big-dict-{{baseDeckId}}.jsonp'], function(){}, function(){}, 1000, undefined, 5);
    } catch(err) {
        document.getElementById('debug-output').innerHTML = err;
    }
</script>

<style>
    body {
        margin: 1px;
        font-size: 20px;
    }
    .panel-group {
        padding: 5px;
    }
    .panel-group .panel + .panel {
        margin-top: 3px;
    }
    .panel-heading {
        padding: 1px;
        cursor: pointer;
        -webkit-user-select: none;
        user-select:none;
    }
    .panel-body {
        padding: 1px;
    }
    .hanzi > .hanzi-char, .hanzi > .hanzi-word {
        cursor: pointer;
    }
    #base-container .hanzi {
        font-size: 35px;
    }
    .chinese-audio .btn {
        text-align:left;
    }
    .btn-toolbar {
        padding: 3px;
        margin: 0px;
        margin-bottom: -4px;
    }
    .btn-toolbar .btn {
        margin: 0px;
        margin-bottom: 4px;
    }
    .btn-block {
        padding: 1px;
        padding-left: 5px;
        padding-right: 5px;
    }
    .form-group {
        margin-bottom: 3px;
    }
    .modal-header {
        padding: 5px;
    }
    .modal-body {
        padding: 5px;
    }
    .modal-body .panel {
        margin-bottom: 3px;
    }
    .stroke-order {
        max-width: 300px;
        margin: 0 auto;
    }
    .etymology {
        white-space: pre;
    }
</style>
