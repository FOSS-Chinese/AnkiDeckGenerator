<div id="base-container">
  <div class="panel-group">
    {{{collapsablePanels}}}
  </div>
</div>

<div class="modal" id="popup" role="dialog">
  <div class="modal-dialog modal-lg" >
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <button class="btn btn-primary modal-title" onclick="Popup.Back();">Back</button>
        <!--<h4 class="modal-title center">Dictionary</h4>-->
      </div>
      <div class="modal-body">
        <div id="popup-content"></div>
      </div>
    </div>
  </div>
</div>

<script>
    try {
        var deckType = "{{deckType}}";
        var panelCount = {{panelCount}};
        {{=<% %>=}}
        var hanzi = "{{hanzi}}";
        var pinyin = "{{pinyin}}";
        var english = "{{english}}";
        <%={{ }}=%>
        function playAudio(audioFile) {
            try {
                new Audio(audioFile).play();
            } catch(html5Err) {
                try {
                    py.link('ankiplay'+audioFile);
                } catch(ankiplayErr) {
                    alert("Your version of Anki doesn't seem to support audio playback from buttons. :(");
                }
            }
        }

        function panelToggle(sectionCount) {
            $('#collapse-' + sectionCount + '}').toggle()
        }

        function generatePanel(heading, content, center, showByDefault) {
            panelCount++;
            var panelHtml = '';
            panelHtml += '<div class="panel panel-primary">';
              panelHtml += '<div class="panel-heading" onclick="panelToggle(' + panelCount + ')">';
                panelHtml += '<h4 class="panel-title">';
                  panelHtml += heading;
                panelHtml += '</h4>';
              panelHtml += '</div>';
              panelHtml += '<div id="collapse-' + panelCount + '" class="panel-collapse collapse ' + (showByDefault ? 'in' : '') + '">';
                panelHtml += '<div class="panel-body ' + (center ? 'text-center' : '') + '">';
                  panelHtml += content;
                panelHtml += '</div>';
              panelHtml += '</div>';
            panelHtml += '</div>';
            panelHtml += '<div>';
            return panelHtml;
        }

        function hanziToHtml(hanzi) {
            var hanziHtml = '';
            if (hanzi.indexOf(' ')!==-1) {
                var words = hanzi.split(' ');
                words.forEach(function(word) {
                    hanziHtml += '<span class="hanzi-word">' + word + '</span> ';
                })
                hanziHtml = hanziHtml.slice(0,-1)
            } else if (hanzi.length>1) { // word
                var chars = hanzi.split('');
                chars.forEach(function(char) {
                    hanziHtml += '<span class="hanzi-char">' + char + '</span>';
                })
            } else { //char
                var char = hanzi;
                hanziHtml = '<span class="hanzi-char">' + char + '</span>';
            }
            return hanziHtml
        }

        var Popup = {
            History: [],
            Open: function(site,noPush) {
                if (site === Popup.History.slice(-1)[0])
                    return
                if (!noPush)
                    Popup.History.push(site);

                var popupContent = '';
                popupContent += generatePanel('Hanzi', '<span class="hanzi">' + hanziToHtml(site) + '</span>', true, true);
                if (site.length === 1)
                    popupContent += generatePanel('Stroke Order', '<' + 'img src="_' + site.charCodeAt() + '-still.svg"/>', true, true);
                popupContent += generatePanel('Chinese Audio', '<div class="chinese-audio">' + getAudioButtons(site) + '</div>', true, true);
                popupContent += generatePanel('English', '<span class="english">' + '?TODO' + '</span>', true, true);
                $("#popup-content").html(popupContent); // TODO:: generate proper page
                $('#popup').modal('show');
            },
            Back: function() {
                if (Popup.History.length <= 1)
                    Popup.Clear();
                if (Popup.History.length > 0) {
                    Popup.History.pop()
                    Popup.Open(Popup.History.pop());
                }
            },
            Clear: function() {
                $('#popup').modal('hide');
                Popup.History=[];
            }
        };

        function getAudioButtons(hanzi) {
            var audioButtons = "";
            audioFiles[hanzi].forEach(function(audioFile, i) {
                var strippedName = audioFile.replace(/^_[^ ]* - /g, '').replace(/.mp3$/, '');
                var onclickContent = "playAudio('" + audioFile + "')";
                var audioButton = '<button class="btn btn-primary" onclick="' + onclickContent + '">' +  'â–¶ ' + strippedName + '</button>';
                audioButtons += audioButton;
            });
            var msg = "";
            if (typeof Audio === 'undefined')
                 msg = '<div style="position:relative;bottom:-6px;font-size: 8px">If audio is not working for you, install the "Replay buttons on card" addon (Code: 498789867).</div>';
            audioButtons = '<div class="btn-toolbar">' + audioButtons + '</div>' + msg;
            return audioButtons;
        }

        var audioFiles = [];
        function onLoadAudio(af) {
            audioFiles = af;
        }
        function onLibsLoaded() {
            //alert("Lib loading succeeded!");
            /*$(".p#base-container anel-body").each(function(){
                if($.trim($(this).html())=='')
                    $(this).parent().parent().hide()
            });*/
            $('#base-hanzi').html(hanziToHtml(hanzi))

            $('body').on('click', '.hanzi', function(event) {
                Popup.Open(event.target.innerHTML);
            });
            $('#popup').on('hidden.bs.modal', function () {
                Popup.Clear();
            });

            var audioButtons = getAudioButtons(hanzi);

            var audioSectionEl = document.querySelector('#base-container').querySelector('.chinese-audio');
            audioSectionEl.innerHTML = audioButtons;
        }
        function onLibsFailed() {
            alert("Lib loading failed!");
        }

        function isBootstrapLoaded() {
            return typeof $ == 'function' && typeof $().modal == 'function'
        }

        function loadLibs(files, success_cb, fail_cb, timeout, check, retries) {
            var timer = setTimeout(fail_cb || function(){alert("loadLibs failed!");}, timeout || 5000);
            var loadCount = 0;
            function onLibLoaded() {
                loadCount++;
                if (loadCount === files.length) {
                    clearTimeout(timer);
                    if (!check) {
                        success_cb();
                    } else if (check()) {
                        success_cb();
                    } else if (retries > 0) {
                        retries--;
                        loadLibs(files, success_cb, fail_cb, timeout, check, retries);
                    }
                }
            }
            files.forEach(function(file){
                if (file[0] !== '_')
                    alert("Error: Please rename '" + file + "' to '_" + file + "'!");
                var ext = file.split('.').slice(-1).pop();
                if (ext === 'js' || ext === 'jsonp') {
                    var script = document.createElement('script');
                    script.src = file;
                    script.addEventListener ("load", onLibLoaded);
                    //script.onload = onLibLoaded;
                    document.getElementsByTagName('head')[0].appendChild(script);
                } else if (ext === 'css') {
                    var css = document.createElement('link');
                    css.rel = 'stylesheet'
                    css.type = 'text/css';
                    css.href = file;
                    css.addEventListener ("load", onLibLoaded);
                    //css.onload = onLibLoaded;
                    document.getElementsByTagName('head')[0].appendChild(css);
                }
            })
        }
        loadLibs(['_jquery-3.js','_bootstrap-3.js','_audio-{{baseDeckId}}.jsonp'], onLibsLoaded, onLibsFailed, 1000, isBootstrapLoaded, 5);
        loadLibs(['_bootstrap-3.css','_bootstrap-3-theme.css'], function(){}, function(){}, 1000);
    } catch(err) {
        document.getElementById('debug-output').innerHTML = err;
    }
</script>

<style>
    body {
        margin: 1px;
        font-size: 20px;
    }
    .panel-heading {
        cursor: pointer;
    }
    .hanzi > .hanzi-char, .hanzi > .hanzi-word {
        cursor: pointer;
    }
    .panel-heading {
        -webkit-user-select: none;
        user-select:none;
    }
    #base-container .hanzi {
        font-size: 35px;
    }
    .chinese-audio .btn{
        width: 100%;
        text-align:left;
    }
    .btn-toolbar .btn {
        margin-bottom: 5px;
    }
    #diagram-container {
        height: 300px;
        width: 100%;
        text-align: left;
        overflow-y: scroll;
    }
    #diagram-container > img {
        width: 100%;
    }
</style>
